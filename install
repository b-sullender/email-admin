#!/bin/bash

# --- Email Admin Installer ---
# Installs admin scripts to /usr/bin and configuration files to /etc/email-admin

set -e  # Exit on any error

# Check if we are running as root
if [ "$(id -u)" -ne 0 ]; then
    echo "Please run as root 'sudo bash install'"
    exit 1
fi

# Directories
BIN_DIR="/usr/bin"
CONF_DIR="/etc/email-admin"

if [[ -d "$CONF_DIR" ]]; then
    echo "Deleting $CONF_DIR ..."
    rm -R $CONF_DIR
fi

# List of scripts to install
SCRIPTS=(
    "configure-opendkim"
    "configure-postfix"
    "configure-dovecot"
    "add-email-domain"
    "add-email-account"
    "delete-email-domain"
    "delete-email-account"
    "purge-email-server"
)

echo "Installing Email Admin scripts ..."

# --- Install scripts to /usr/bin ---
for script in "${SCRIPTS[@]}"; do
    if [[ -f "$script" ]]; then
        echo "Installing $script -> $BIN_DIR/$script"
        cp "$script" "$BIN_DIR/$script"
        chmod +x "$BIN_DIR/$script"
    else
        echo "Warning: Script '$script' not found in current directory, skipping."
    fi
done

# --- Copy postfix configuration directory ---
if [[ -d "postfix" ]]; then
    echo "Copying postfix/ -> $CONF_DIR"
    mkdir -p "$CONF_DIR"
    cp -R postfix "$CONF_DIR/"
else
    echo "Warning: Directory 'postfix/' not found, skipping copy to $CONF_DIR."
fi

# --- Copy dovecot configuration directory ---
if [[ -d "dovecot" ]]; then
    echo "Copying dovecot/ -> $CONF_DIR"
    mkdir -p "$CONF_DIR"
    cp -R dovecot "$CONF_DIR/"
else
    echo "Warning: Directory 'dovecot/' not found, skipping copy to $CONF_DIR."
fi

# --- Copy common.sh ---
echo "Copying common.sh ..."
cp common.sh $CONF_DIR/common.sh

echo "Installation complete."
echo "Installed scripts:"
for script in "${SCRIPTS[@]}"; do
    echo "  - $BIN_DIR/$script"
done
echo "Configuration directory: $CONF_DIR"
