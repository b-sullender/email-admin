#!/bin/bash

set -e  # Exit on any error

# Check if we are running as root
if [ "$(id -u)" -ne 0 ]; then
    echo "Please run as root 'sudo delete-email-account'"
    exit 1
fi

# Prompt for input
read -p "Enter domain name (e.g. example.com): " domain_name

if [[ -z "$domain_name" ]]; then
    echo "Error: Domain name cannot be empty."
    exit 1
fi

read -p "Enter email username (e.g. admin): " email_username

domain_email="${email_username}@${domain_name}"

if [[ -z "$email_username" ]]; then
    echo "Error: Username cannot be empty."
    exit 1
fi

echo "Deleting mail account: ${domain_email}"

# Confirm action
read -p "Are you sure you want to delete this account? [y/N]: " confirm
if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
    echo "Operation cancelled."
    exit 1
fi

# Remove entries from Postfix virtual mailbox map
sed -i "\|^${domain_email}[[:space:]]|d" /etc/postfix/virtual_mailbox_maps

# Remove all aliases pointing to this email
sed -i "\|[[:space:]]${domain_email}[[:space:]]*$|d" /etc/postfix/virtual_alias_maps

# Remove user entry from Dovecot passwd file
sed -i "/^${email_username}:/d" /etc/dovecot/passwd

# Update Postfix maps
postmap /etc/postfix/virtual_alias_maps
postmap /etc/postfix/virtual_mailbox_maps

# Remove user mail directory
rm -rf /var/mail/vhosts/${domain_name}/${email_username}

# Reload services
systemctl reload postfix
systemctl reload dovecot

echo "Email account ${domain_email} has been successfully deleted."
